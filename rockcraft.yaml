name: magma-orc8r-controller
summary: Magma Orchestrator Controller
description: |
  Magma Orchestrator Controller
version: "1.6.0"
license: Apache-2.0
base: ubuntu:18.04
platforms:
  amd64:

entrypoint: ["/bin/pebble", "run", "-v"]

parts:

  magma-orc8r-controller:
    plugin: dump
    source: https://github.com/magma/magma
    source-type: git
    source-tag: v1.6
    build-packages:
      - unzip
      - wget
    stage-packages:
      - daemontools
      - netcat
      - openssl
      - supervisor
    override-build: |
      set -x
      
      # Golang 1.13
      snap remove go
      cd /usr/local && curl https://facebookconnectivity.jfrog.io/artifactory/generic/go1.13.4.linux-amd64.tar.gz -O && tar xf go1.13.4.linux-amd64.tar.gz && cp -r go/bin/* /usr/local/bin/
      curl -Lfs https://github.com/google/protobuf/releases/download/v3.1.0/protoc-3.1.0-linux-x86_64.zip -o protoc3.zip && unzip protoc3.zip -d protoc3 && cp -r protoc3/bin/protoc /bin/protoc && chmod a+rx /bin/protoc && cp -r protoc3/include/google /usr/include/ && chmod -R a+Xr /usr/include/google && rm -rf protoc3.zip protoc3
      
      # GO modules
      export MAGMA_MODULES="orc8r lte feg"
      export MAGMA_ROOT=/src/magma
      export GOBIN=/build/bin
      export GO111MODULE=on
      export GOPATH=/root/go
      export PATH=${PATH}:${GOBIN}:${GOPATH}/bin
      echo "export GOCACHE_MODULES=\"$(for m in $MAGMA_MODULES ; do echo -n /gomod/src/magma/$m ; echo -n ' ' ; done)\"" >> /etc/profile.d/env.sh
      mkdir -p gomod/src/magma/orc8r/cloud/go
      mkdir -p gomod/src/magma/orc8r/gateway/go
      mkdir -p gomod/src/magma/orc8r/lib/go
      mkdir -p gomod/src/magma/orc8r/lib/go/protos
      mkdir -p gomod/src/magma/lte/cloud/go
      mkdir -p gomod/src/magma/feg/cloud/go
      mkdir -p gomod/src/magma/feg/cloud/go/protos
      cp $CRAFT_PART_SRC/orc8r/cloud/go/go.mod gomod/src/magma/orc8r/cloud/go/
      cp $CRAFT_PART_SRC/orc8r/lib/go/go.mod gomod/src/magma/orc8r/lib/go/
      cp $CRAFT_PART_SRC/orc8r/lib/go/protos/go.mod gomod/src/magma/orc8r/lib/go/protos/
      cp $CRAFT_PART_SRC/orc8r/gateway/go/go.mod gomod/src/magma/orc8r/gateway/go/
      cp $CRAFT_PART_SRC/lte/cloud/go/go.mod gomod/src/magma/lte/cloud/go/
      cp $CRAFT_PART_SRC/feg/cloud/go/go.mod gomod/src/magma/feg/cloud/go/
      cp $CRAFT_PART_SRC/feg/cloud/go/protos/go.mod gomod/src/magma/feg/cloud/go/protos/
      cp -r gomod /
      cd /gomod/src/magma/cloud/go && echo /gomod/src/magma/cloud/go && go mod download
      . /etc/profile.d/env.sh && for m in $GOCACHE_MODULES ; do cd ${m}/cloud/go && echo ${m}/cloud/go && go mod download ; done
      
      # Src
      export MAGMA_MODULES="orc8r lte feg"
      export MAGMA_ROOT=/src/magma
      export GOBIN=/build/bin
      export GO111MODULE=on
      export GOPATH=/root/go
      export PATH=${PATH}:${GOBIN}:${GOPATH}/bin
      mkdir -p src/magma/orc8r
      cp -r $CRAFT_PART_SRC/orc8r/cloud src/magma/orc8r/
      cp -r $CRAFT_PART_SRC/orc8r/gateway src/magma/orc8r/
      cp -r $CRAFT_PART_SRC/orc8r/lib src/magma/orc8r/
      cp -r $CRAFT_PART_SRC/lte/cloud src/magma/lte/
      cp -r $CRAFT_PART_SRC/feg/cloud src/magma/feg/
      echo "export MAGMA_MODULES=\"$(for m in $MAGMA_MODULES ; do echo -n /src/magma/$m ; echo -n ' ' ; done)\"" >> /etc/profile.d/env.sh
      cp -r src /
      mkdir -p /src/magma/lte_tools
      cd /src/magma/orc8r/cloud && . /etc/profile.d/env.sh && make tools
      
      # Compile
      . /etc/profile.d/env.sh && make build
      
      # Structure staging area
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/envdir
      mkdir -p ${CRAFT_PART_INSTALL}/etc/magma/configs/orc8r/
      mkdir -p ${CRAFT_PART_INSTALL}/etc/magma/configs/feg/
      mkdir -p ${CRAFT_PART_INSTALL}/etc/magma/configs/lte/
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/ui/
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/static/
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/spec/
      mkdir -p ${CRAFT_PART_INSTALL}/etc/supervisor/conf.d/
      mkdir -p ${CRAFT_PART_INSTALL}/usr/local/lib/python2.7/dist-packages/
      
      # Production
      export SWAGGER_UI_VERSION="3.1.7"
      cd /tmp && wget "https://github.com/swagger-api/swagger-ui/archive/v$SWAGGER_UI_VERSION.zip" && unzip "v$SWAGGER_UI_VERSION.zip" -d swagger-ui && mkdir -p /var/opt/magma/static/swagger-ui && cp -r "swagger-ui/swagger-ui-$SWAGGER_UI_VERSION/dist" ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger-ui
      cp -r /build/bin ${CRAFT_PART_INSTALL}/var/opt/magma
      
      # Move to stage
      export SWAGGER_FILES=src/magma/orc8r/cloud/go/obsidian/swagger
      export CNTLR_FILES=/src/magma/orc8r/cloud/docker/controller
      cp /src/magma/orc8r/cloud/docker/wait-for-it.sh ${CRAFT_PART_INSTALL}/usr/local/bin
      cp /${SWAGGER_FILES}/v1/index.html ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/ui/index.html
      cp /${SWAGGER_FILES}/v1/css/sidebar.css ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/static/sidebar.css
      cp /${SWAGGER_FILES}/v1/swagger.yml ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/spec/swagger.yml
      cp -r /src/magma/orc8r/cloud/swagger ${CRAFT_PART_INSTALL}/etc/magma/swagger
      cp -r /build/bin ${CRAFT_PART_INSTALL}/var/opt/magma/bin
      cp ${CNTLR_FILES}/supervisord.conf ${CRAFT_PART_INSTALL}/etc/supervisor/conf.d/supervisord.conf
      cp ${CNTLR_FILES}/supervisor_logger.py ${CRAFT_PART_INSTALL}/usr/local/lib/python2.7/dist-packages/supervisor_logger.py
      cp ${CNTLR_FILES}/create_test_controller_certs ${CRAFT_PART_INSTALL}/usr/local/bin
      cp -r /build/bin ${CRAFT_PART_INSTALL}/var/opt/magma
      cp -r $CRAFT_PART_SRC/orc8r/cloud/configs/* ${CRAFT_PART_INSTALL}/etc/magma/configs/orc8r
      cp -r $CRAFT_PART_SRC/lte/cloud/configs/* ${CRAFT_PART_INSTALL}/etc/magma/configs/lte
      cp -r $CRAFT_PART_SRC/feg/cloud/configs/* ${CRAFT_PART_INSTALL}/etc/magma/configs/feg

  default-config:
    plugin: dump
    source: files
    organize:
      001-default.yaml: var/lib/pebble/default/layers/001-default.yaml
    stage:
      - var/lib/pebble/default/layers/001-default.yaml
