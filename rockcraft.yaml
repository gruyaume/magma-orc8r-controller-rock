name: magma-orc8r-controller
summary: Magma Orchestrator Controller
description: |
  Magma Orchestrator Controller
version: "1.6.0"
license: Apache-2.0
base: ubuntu:18.04
platforms:
  amd64:

cmd: ["/usr/bin/envdir", "/var/opt/magma/envdir", "/var/opt/magma/bin/orchestrator", "-logtostderr=true", "-v=0"]

parts:

  src-files:
    plugin: dump
    source: files/src
    stage:
      - src/magma
    organize:
      magma/: src/magma/

  golang:
    plugin: dump
    source: https://facebookconnectivity.jfrog.io/artifactory/generic/go1.13.4.linux-amd64.tar.gz
    override-build: |
      set -x
      snap remove go
      craftctl default

  protobuf:
    plugin: dump
    source: https://github.com/google/protobuf/releases/download/v3.1.0/protoc-3.1.0-linux-x86_64.zip
    stage:
      - bin/protoc
    override-stage: |
      set -x
      ls
      cp -r ${CRAFT_PART_INSTALL}/bin/protoc ${CRAFT_STAGE}/bin/protoc
      craftctl default

  magma-orc8r-controller:
    plugin: dump
    source: https://github.com/magma/magma
    after: [golang, protobuf, src-files]
    source-type: git
    source-tag: v1.6
    build-packages:
      - bzr
      - curl
      - gcc
      - git
      - make
      - unzip
      - vim
      - protobuf-compiler
    stage-packages:
      - daemontools
      - netcat
      - openssl
      - supervisor
    override-build: |
      set -x
      go version
      protoc version

      export GO111MODULE="on"
      export GOPATH="/root/go"
      export GOBIN="/build/bin"
      export PATH=${PATH}:${GOBIN}:${GOPATH}/bin
      export MAGMA_ROOT="/src/magma"

      export MAGMA_MODULES="orc8r lte"
      echo "export GOCACHE_MODULES=\"$(for m in $MAGMA_MODULES ; do echo -n /gomod/src/magma/$m ; echo -n ' ' ; done)\"" >> /etc/profile.d/env.sh

      # GO modules
      mkdir -p gomod/src/magma/orc8r/cloud/go
      mkdir -p gomod/src/magma/orc8r/gateway/go
      mkdir -p gomod/src/magma/orc8r/lib/go
      mkdir -p gomod/src/magma/orc8r/lib/go/protos
      mkdir -p gomod/src/magma/lte/cloud/go
      mkdir -p gomod/src/magma/feg/cloud/go
      mkdir -p gomod/src/magma/feg/cloud/go/protos
      cp $CRAFT_PART_SRC/orc8r/cloud/go/go.mod gomod/src/magma/orc8r/cloud/go/
      cp $CRAFT_PART_SRC/orc8r/lib/go/go.mod gomod/src/magma/orc8r/lib/go/
      cp $CRAFT_PART_SRC/orc8r/lib/go/protos/go.mod gomod/src/magma/orc8r/lib/go/protos/
      cp $CRAFT_PART_SRC/orc8r/gateway/go/go.mod gomod/src/magma/orc8r/gateway/go/
      cp $CRAFT_PART_SRC/lte/cloud/go/go.mod gomod/src/magma/lte/cloud/go/
      cp $CRAFT_PART_SRC/feg/cloud/go/go.mod gomod/src/magma/feg/cloud/go/
      cp $CRAFT_PART_SRC/feg/cloud/go/protos/go.mod gomod/src/magma/feg/cloud/go/protos/
      cp -rf gomod /
      export MAGMA_MODULES="orc8r lte"
      export MAGMA_ROOT="/src/magma"
      echo "export GOCACHE_MODULES=\"$(for m in $MAGMA_MODULES ; do echo -n /gomod/src/magma/$m ; echo -n ' ' ; done)\"" >> /etc/profile.d/env.sh
      cat /etc/profile.d/env.sh
      . /etc/profile.d/env.sh
      export GO111MODULE="on"
      export GOBIN="/build/bin"
      export GOPATH="/root/go"
      export PATH=${PATH}:${GOBIN}:${GOPATH}/bin
      ls /gomod/src/magma/lte/cloud/go
      for m in $GOCACHE_MODULES ; do cd ${m}/cloud/go && echo ${m}/cloud/go && go mod download ; done

      ls $CRAFT_STAGE/src
      cp -r $CRAFT_STAGE/src /

      export MAGMA_MODULES="orc8r lte"
      echo "export MAGMA_MODULES=\"$(for m in $MAGMA_MODULES ; do echo -n /src/magma/$m ; echo -n ' ' ; done)\"" >> /etc/profile.d/env.sh
      cat /etc/profile.d/env.sh
      cd /src/magma/orc8r/cloud

      . /etc/profile.d/env.sh
      export GO111MODULE="on"
      export GOBIN="/build/bin"
      export GOPATH="/root/go"
      env
      make tools

      # Compile

      cd /src/magma/orc8r/cloud
      ls
      export MAGMA_ROOT="/src/magma"
      export GO111MODULE=on
      export MAGMA_ROOT=/src/magma
      export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/build/bin:/go/bin
      export GOBIN=/build/bin
      export GOPATH=/go
      export GOCACHE_MODULES="/gomod/src/magma/orc8r /gomod/src/magma/lte "
      export MAGMA_MODULES="/src/magma/orc8r /src/magma/lte "
      env
      make build
      ls /build/bin
