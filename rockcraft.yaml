name: magma-orc8r-controller
summary: Magma Orchestrator Controller
description: |
  Magma Orchestrator Controller
version: "1.6.1"
license: Apache-2.0
base: ubuntu:18.04
platforms:
  amd64:

cmd: ["/usr/bin/envdir", "/var/opt/magma/envdir", "/var/opt/magma/bin/orchestrator", "-logtostderr=true", "-v=0"]

env:
  - DATABASE_SOURCE: "dbname=magma user=username password=password host=127.0.0.1 sslmode=disable"
  - SQL_DRIVER: postgres
  - SQL_DIALECT: psql
  - SERVICE_HOSTNAME: magma-orc8r-certifier
  - SERVICE_REGISTRY_MODE": k8s
  - SERVICE_REGISTRY_NAMESPACE": namespace

parts:

  swagger:
    plugin: dump
    source: https://github.com/swagger-api/swagger-ui/archive/v3.1.7.zip
    organize:
      swagger-ui-3.1.7/dist: var/opt/magma/static/swagger-ui/dist/
    stage:
      - var/opt/magma/static/swagger-ui/

  golang:
    plugin: nil
    override-build: |
      snap switch go --channel=1.13/stable
      snap refresh go

  magma-orc8r-controller:
    plugin: dump
    source: https://github.com/magma/magma
    after: [golang]
    source-type: git
    source-tag: v1.6.1
    build-packages:
      - curl
      - protobuf-compiler
    stage-packages:
      - daemontools
      - netcat
      - openssl
      - supervisor
    stage:
      - var/opt/magma
      - etc/magma
      - etc/supervisor
      - usr/local/bin
      - usr/local/lib
      - usr/bin/envdir
    build-environment:
      - MAGMA_MODULES: "/src/magma/orc8r /src/magma/lte /src/magma/feg"
      - MAGMA_ROOT: "/src/magma"
      - GO111MODULE: "on"
      - GOPATH: "/root/go"
      - GOBIN: "/build/bin"
      - PATH: "${PATH}:${GOBIN}:${GOPATH}/bin"
    organize:
      /configs/*: etc/magma/
      /src/magma/orc8r/cloud/docker/controller/create_test_controller_certs: usr/local/bin/create_test_controller_certs
      /src/magma/orc8r/cloud/docker/controller/supervisor_logger.py: usr/local/lib/python2.7/dist-packages/supervisor_logger.py
      /src/magma/orc8r/cloud/docker/controller/supervisord.conf: etc/supervisor/conf.d/supervisord.conf
      /build/bin: var/opt/magma/bin
      /src/magma/orc8r/cloud/swagger: etc/magma/swagger
      /src/magma/orc8r/cloud/go/obsidian/swagger/v1/swagger.yml: var/opt/magma/static/swagger/v1/spec/swagger.yml
      /src/magma/orc8r/cloud/go/obsidian/swagger/v1/css/sidebar.css: var/opt/magma/static/swagger/v1/static/sidebar.css
      /src/magma/orc8r/cloud/go/obsidian/swagger/v1/index.html: var/opt/magma/static/swagger/v1/ui/index.html
      /src/magma/orc8r/cloud/docker/wait-for-it.sh: usr/local/bin/wait-for-it.sh
    override-build: |
      set -x
      
      mkdir -p ${CRAFT_PART_INSTALL}/etc/magma/configs
      mkdir -p ${CRAFT_PART_INSTALL}/usr/local/bin
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/envdir
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/ui/
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/static/
      mkdir -p ${CRAFT_PART_INSTALL}/var/opt/magma/static/swagger/v1/spec/
      mkdir -p ${CRAFT_PART_INSTALL}/etc/magma/swagger
      mkdir -p ${CRAFT_PART_INSTALL}/usr/local/lib/python2.7/dist-packages/
      
      mkdir -p /src/magma/orc8r/
      mkdir -p /src/magma/lte/
      mkdir -p /src/magma/feg/
      mkdir -p /configs/orc8r/
      mkdir -p /configs/lte/
      mkdir -p /configs/feg/
      
      mkdir -p /gomod/src/magma/orc8r/cloud/go/
      mkdir -p /gomod/src/magma/orc8r/cloud/test/
      mkdir -p /gomod/src/magma/orc8r/gateway/go/
      mkdir -p /gomod/src/magma/orc8r/lib/go/
      mkdir -p /gomod/src/magma/orc8r/lib/go/protos/
      mkdir -p /gomod/src/magma/lte/cloud/go/
      mkdir -p /gomod/src/magma/feg/cloud/go/
      mkdir -p /gomod/src/magma/feg/cloud/go/protos/
      
      cp -r orc8r/cloud /src/magma/orc8r/
      cp -r orc8r/gateway /src/magma/orc8r/
      cp -r orc8r/lib /src/magma/orc8r/
      cp -r lte/cloud /src/magma/lte/
      cp -r feg/cloud /src/magma/feg/
      cp -r orc8r/cloud/configs/ /configs/orc8r/
      cp -r lte/cloud/configs/ /configs/lte/
      cp -r feg/cloud/configs/ /configs/feg/
      
      cp orc8r/cloud/go/go.mod /gomod/src/magma/orc8r/cloud/go/
      cp orc8r/cloud/test/go.mod /gomod/src/magma/orc8r/cloud/test/
      cp orc8r/gateway/go/go.mod /gomod/src/magma/orc8r/gateway/go/
      cp orc8r/lib/go/go.mod /gomod/src/magma/orc8r/lib/go/
      cp orc8r/lib/go/protos/go.mod /gomod/src/magma/orc8r/lib/go/protos/
      cp lte/cloud/go/go.mod /gomod/src/magma/lte/cloud/go/
      cp feg/cloud/go/go.mod /gomod/src/magma/feg/cloud/go/
      cp feg/cloud/go/protos/go.mod /gomod/src/magma/feg/cloud/go/protos/

      # Go modules
      cd /gomod/src/magma/orc8r/cloud/go && go mod download
      cd /gomod/src/magma/lte/cloud/go && go mod download
      cd /gomod/src/magma/feg/cloud/go && go mod download
      
      # Build
      cd /src/magma/orc8r/cloud
      make tools
      make build
